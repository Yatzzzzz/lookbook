/** * KlingAI API client-side implementation * Handles image conversion and API interaction for virtual try-on */ // Interface for try-on request parameters interface TryOnRequest { userImageUrl: string; outfitImageUrl: string; tryOnType: 'full' | 'upper' | 'lower'; modelVersion?: 'v1' | 'v1.5'; } // Maximum image size in bytes (10MB as per KlingAI specifications) const MAX_IMAGE_SIZE = 10 * 1024 * 1024; /** * Converts an image URL to base64 - strips data URI prefix for KlingAI * @param url URL of the image to convert * @returns Promise resolving to base64 string without prefix (as required by KlingAI) */ async function imageUrlToBase64(url: string): Promise<string> { try { // Fetch the image const response = await fetch(url, { // For cross-origin images, make sure we don't get CORS issues mode: 'cors', cache: 'no-cache' }); if (!response.ok) { throw new Error(`Failed to fetch image: ${response.statusText}`); } // Convert to blob const blob = await response.blob(); // Check file size before conversion if (blob.size > MAX_IMAGE_SIZE) { throw new Error(`Image size (${Math.round(blob.size / 1024 / 1024 * 100) / 100}MB) exceeds maximum (${MAX_IMAGE_SIZE / 1024 / 1024}MB)`); } // Use FileReader to convert blob to base64 return new Promise((resolve, reject) => { const reader = new FileReader(); reader.onloadend = () => { // FileReader result is a string that looks like: // data:image/jpeg;base64,/9j/4AAQSkZJRgABAQAAAQABAAD/... // KlingAI wants ONLY the base64 part without the prefix const base64String = reader.result as string; const base64Data = base64String.split(',')[1]; resolve(base64Data); }; reader.onerror = reject; reader.readAsDataURL(blob); }); } catch (error) { console.error('Error converting image to base64:', error); throw error; } } /** * Client-side implementation of try-on functionality * This uses the server-side API route to avoid JWT issues in the browser * @returns The result image URL or a placeholder for errors */ export async function tryOnOutfit({ userImageUrl, outfitImageUrl, tryOnType = 'full', modelVersion = 'v1.5' }: TryOnRequest): Promise<string> { try { console.log('Using server-side API route for KlingAI try-on'); console.log(`Model version: ${modelVersion}, Try-on type: ${tryOnType}`); // Validate URLs before fetching try { new URL(userImageUrl); } catch (error) { console.error('Invalid user URL format:', error); return 'https://placehold.co/600x900/orange/white?text=Invalid+User+URL+Format'; } // Validate outfit URL if (!outfitImageUrl) { console.error('Outfit image URL is required'); return 'https://placehold.co/600x900/orange/white?text=Outfit+Image+URL+Required'; } try { new URL(outfitImageUrl); } catch (error) { console.error('Invalid outfit URL format:', error); return 'https://placehold.co/600x900/orange/white?text=Invalid+Outfit+URL+Format'; } // Validate try-on type if (!['full', 'upper', 'lower'].includes(tryOnType)) { console.error('Invalid try-on type:', tryOnType); return 'https://placehold.co/600x900/orange/white?text=Invalid+Try-On+Type'; } // Validate model version if (!['v1', 'v1.5'].includes(modelVersion)) { console.error('Invalid model version:', modelVersion); return 'https://placehold.co/600x900/orange/white?text=Invalid+Model+Version'; } // Convert userImage to base64 let userImageBase64: string; try { console.log('Converting user image to base64...'); userImageBase64 = await imageUrlToBase64(userImageUrl); console.log('User image converted to base64 successfully'); } catch (error) { console.error('Failed to convert user image to base64:', error); return 'https://placehold.co/600x900/orange/white?text=Failed+to+convert+user+image'; } // Convert outfit image to base64 as well for better reliability let outfitImageBase64: string | null = null; try { console.log('Converting outfit image to base64...'); outfitImageBase64 = await imageUrlToBase64(outfitImageUrl); console.log('Outfit image converted to base64 successfully'); } catch (error) { console.error('Failed to convert outfit image to base64, will use URL instead:', error); // We'll continue with the URL approach if this fails if (!outfitImageUrl) { return 'https://placehold.co/600x900/orange/white?text=Outfit+Image+Required'; } } // Log the parameters we're sending to the API console.log(`Sending request with parameters: user image (converted to base64), outfit image (${outfitImageBase64 ? 'converted to base64' : 'using URL'}), type: ${tryOnType}, model: ${modelVersion}`); // Use the server-side API route console.log('Sending request to server-side API...'); try { const response = await fetch('/api/tryon', { method: 'POST', headers: { 'Content-Type': 'application/json', }, body: JSON.stringify({ imageBase64: userImageBase64, outfitUrl: outfitImageUrl, outfitBase64: outfitImageBase64, // Send both when available type: tryOnType, modelVersion: modelVersion }), }); // Get the response as text first const responseText = await response.text(); // Handle empty responses if (!responseText || responseText.trim() === '') { console.error('Empty response received from API'); return 'https://placehold.co/600x900/orange/white?text=Empty+Response+From+API'; } // Try to parse as JSON let data: any = {}; try { data = JSON.parse(responseText); } catch (parseError) { console.error('Failed to parse response as JSON:', responseText); return 'https://placehold.co/600x900/orange/white?text=Invalid+Response+Format'; } // Handle empty JSON objects if (data && typeof data === 'object' && Object.keys(data).length === 0) { console.error('API returned empty JSON object'); return 'https://placehold.co/600x900/orange/white?text=API+Returned+Empty+Object'; } // Log the response for debugging without causing errors const safeData = data || {}; console.log('KlingAI response:', safeData); // Handle error responses if (!response.ok) { console.log('Response not OK, status:', response.status); // If the server already provided a placeholder image, use it if (safeData.resultImageUrl) { return safeData.resultImageUrl; } // Create specific error messages for common error codes if (safeData.details && safeData.details.code) { switch (safeData.details.code) { case 1200: return 'https://placehold.co/600x900/orange/white?text=Invalid+Parameters:+Check+Image+Format+and+Size'; case 1000: case 1001: case 1002: case 1003: case 1004: return 'https://placehold.co/600x900/orange/white?text=Authentication+Error:+Please+Try+Again+Later'; default: return `https://placehold.co/600x900/orange/white?text=API+Error+${safeData.details.code}:+${encodeURIComponent(safeData.error || 'Unknown Error')}`; } } // Otherwise create our own placeholder with error details const errorMessage = safeData.error || safeData.details || `API error: ${response.status}`; return 'https://placehold.co/600x900/orange/white?text=API+Error:+' + encodeURIComponent(errorMessage); } // Handle successful response with missing image URL if (!safeData.success || !safeData.resultImageUrl) { console.error('Missing result image URL in response:', safeData); return 'https://placehold.co/600x900/orange/white?text=No+Image+Returned'; } // Return the successful result return safeData.resultImageUrl; } catch (networkError: any) { console.error('Network error making API request:', networkError); return 'https://placehold.co/600x900/orange/white?text=Network+Error:+' + encodeURIComponent(networkError.message || 'Failed to connect to server'); } } catch (error: any) { // Log the error but don't throw it again console.error('Error in KlingAI tryOnOutfit:', error); // Return a fallback image URL return 'https://placehold.co/600x900/orange/white?text=Error:+' + encodeURIComponent(error.message || 'Unknown error'); } } 